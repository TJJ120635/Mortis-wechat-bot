# å®ç°å¸¦è”ç½‘æœç´¢èƒ½åŠ›çš„å¢¨ç¼‡ä¸å¾®ä¿¡ç¾¤èŠåŠ©æ‰‹ DeepSeek+AstrBot+Dify

å¼€å§‹ä¹‹å‰å…ˆçœ‹çœ‹æ•ˆæœ
![](attachments\Pasted image 20250224111805.png)

## ä¸€ã€èƒŒæ™¯

æƒ³è¦å°† DeepSeek-R1 ä»¥ç¾¤æœºå™¨äººçš„æ–¹å¼æ¥å…¥åˆ°å¾®ä¿¡ç¾¤ä¸­
ç½‘ä¸Šæœ‰æ¯”è¾ƒå¤šå¾®ä¿¡/QQæœºå™¨äºº+å¤§æ¨¡å‹çš„æ¡†æ¶
ä¾‹å¦‚ LangBot/chatgpt-on-wechat/AstrBot/wechat-bot/chatgpt-mirai-qq-bot ç­‰ç­‰

æˆ‘å¸Œæœ›å…·å¤‡çš„åŠŸèƒ½ï¼š
- æ¥å…¥ä¸ªäººå¾®ä¿¡
- æ”¯æŒè®°å½•å¾®ä¿¡ç¾¤èŠè®°å½•ä¸Šä¸‹æ–‡
- æ”¯æŒ DeepSeek-R1
- æ”¯æŒè”ç½‘æœç´¢åŠŸèƒ½
- æœªæ¥è€ƒè™‘å®ç°é•¿æ—¶è®°å¿†èƒ½åŠ›ï¼ˆè®©å¤§æ¨¡å‹å®šæœŸæ•´ç†è®°å¿†ï¼‰

ç»¼åˆè€ƒè™‘ä¸‹é¢çš„æŠ€æœ¯è·¯çº¿ï¼š
- å¤§æ¨¡å‹åº•åº§+è”ç½‘æœç´¢ï¼šç«å±±æ–¹èˆŸ https://console.volcengine.com/ark
- æ ¸å¿ƒæ¡†æ¶ï¼šAstrBot https://github.com/Soulter/AstrBot
- æ¶ˆæ¯å¹³å°æœåŠ¡ï¼šGewechat https://github.com/Devo919/Gewechat
- å¤§æ¨¡å‹åº”ç”¨ç¼–æ’ï¼šDify https://github.com/langgenius/dify
- OpenAI æ ¼å¼è½¬æ¢ï¼šnew-api https://github.com/Calcium-Ion/new-api?tab=readme-ov-file
å¦‚æœä¸éœ€è¦é‚£ä¹ˆå¤æ‚çš„åŠŸèƒ½
æˆ‘å»ºè®®ç”¨ **ç«å±±æ–¹èˆŸ+AstrBot+Gewechat** çš„ç»„åˆå³å¯
ä¸€é”®éƒ¨ç½²åç®€å•é…ç½®å°±èƒ½å¼€å§‹ç©ï¼Œéå¸¸æ–¹ä¾¿

æŠ€æœ¯è·¯çº¿è€ƒè™‘å¦‚ä¸‹ï¼š
- ç«å±±æ–¹èˆŸåº•åº§ï¼šæ»¡è¡€+æ— æˆªæ–­ DeepSeek-R1ï¼ŒæœåŠ¡ç¨³å®šæ€§ä¼˜ç§€ï¼Œå…è´¹ 50ä¸‡ tokensï¼Œé‚€è¯·å¥½å‹æ³¨å†Œé€ 30 ä»£é‡‘åˆ¸ã€‚è¾“å…¥ 0.0040Â å…ƒ/åƒtokensï¼Œè¾“å‡º 0.0160Â å…ƒ/åƒtokens
- ç«å±±æ–¹èˆŸè”ç½‘æœç´¢ï¼šæ”¯æŒ DeepSeek-R1+è”ç½‘æœç´¢ç»“æœåˆ†æï¼Œæœç´¢è´¨é‡ä¼˜äºè…¾è®¯å¤§æ¨¡å‹çŸ¥è¯†å¼•æ“ï¼Œè´¨é‡æ¥è¿‘ Bingï¼Œæ³¨å†Œæ¯” Azure æ–¹ä¾¿
- AstrBot æ¡†æ¶ï¼šæ”¯æŒä¸ªäººå¾®ä¿¡æ¥å…¥ï¼ˆåŸºäº Gewechatï¼‰ï¼Œæ”¯æŒ Difyï¼Œæœ‰æ’ä»¶ç”Ÿæ€
- Gewechat æ¶ˆæ¯å¹³å°ï¼šAstrBot ç”¨çš„æ˜¯è¿™ä¸ªæ‰€ä»¥å°±ç”¨äº†
- Dify ç¼–æ’æ¡†æ¶ï¼šèŠå¤©åŠ©æ‰‹/æ™ºèƒ½ä½“/å·¥ä½œæµ/å¯¹è¯æµ ç­‰å¤šç§å½¢å¼ï¼Œå¯è§†åŒ–ç¼–è¾‘å®¹æ˜“ä¸Šæ‰‹ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨ã€HTTP è¯·æ±‚ã€Python ä»£ç ç­‰ä¸°å¯ŒåŠŸèƒ½
- new-api æœåŠ¡ï¼šåŸºäº one-apiï¼Œæ”¯æŒ Dify

ä¸ºä»€ä¹ˆè¦ç”¨ Difyï¼Ÿ
- æœ€å¼€å§‹æˆ‘æƒ³è¦å®ç° DeepSeek-R1+è”ç½‘æœç´¢
- AstrBot æœ‰è”ç½‘æ’ä»¶ï¼ŒåŸºäº Agent å‡½æ•°è°ƒç”¨çš„æ–¹å¼ï¼Œé€‚åˆ GPT-4oã€Gemini ç­‰æ¨¡å‹ï¼ŒDeepSeek-R1 ä¸æ”¯æŒ
- æƒ³è¦å®ç°è”ç½‘è¦è‡ªå·±ç”¨ Dify æ­å»ºå·¥ä½œæµ
ä¸ºä»€ä¹ˆè¦ç”¨ new-apiï¼Ÿ
- AstrBot æ”¯æŒæ¥å…¥ Dify çš„èŠå¤©åŠ©æ‰‹/å·¥ä½œæµ/å¯¹è¯æµï¼Œä½†æ˜¯ä¼ å…¥çš„å‚æ•°é‡Œæ²¡æœ‰ç¾¤èŠæ¶ˆæ¯è®°å½•
- AstrBot æ¥å…¥ Dify æ¨¡å¼æ— æ³•ä¼ å…¥ç¾¤èŠæ¶ˆæ¯è®°å½•ï¼Œåªèƒ½ä½¿ç”¨ Dify è‡ªå¸¦çš„ä¸Šä¸‹æ–‡è®°å¿†ï¼Œæ— æ³•ä¼ å…¥ç¾¤å‹ ID
- AstrBot æ¥å…¥ OpenAI æ ¼å¼æ¥å£èƒ½å¤Ÿä¼ å…¥ç¾¤èŠæ¶ˆæ¯è®°å½•ï¼Œå¸¦æœ‰æ—¶é—´æˆ³å’Œç¾¤å‹ ID ç­‰ä¿¡æ¯
- å› æ­¤è€ƒè™‘ç”¨ new-api å°† Dify è½¬æˆ OpenAI æ ¼å¼æ¥å£
## äºŒã€éƒ¨ç½²ç¯å¢ƒ

éœ€è¦ä¸€å°æ”¯æŒ Docker ä¸” 24 å°æ—¶ä¸å…³æœºçš„æœºå™¨ï¼ŒWindows/Linux ä¸é™
å¦‚æœå®¶é‡Œæ²¡æœ‰ç”µè„‘å¯ä»¥è€ƒè™‘ç½‘ä¸Šç§Ÿä¸€å°ä¾¿å®œçš„äº‘æœåŠ¡å™¨
æ€§èƒ½è¦æ±‚å¾ˆä½ï¼Œæˆ‘ä¼°è®¡ 2C4G çš„ Linux æœºå™¨å°±è¡Œ

æˆ‘è‡ªå·±ç”¨çš„æ˜¯å®¶é‡Œçš„ææ‘©å®¢ K1 è¿·ä½ ç”µè„‘
å¹³æ—¶ç”¨æ¥æŒ‚ MAAï¼Œè£…äº†ä¸€ä¸ª Docker Desktop éƒ¨ç½²æœåŠ¡

![](attachments\Pasted image 20250224113413.png)
## ä¸‰ã€æ³¨å†Œç«å±±æ–¹èˆŸæœåŠ¡

#### 3.1 è´¦å·æ³¨å†Œ
è¿›å…¥ç«å±±å¼•æ“å®˜ç½‘å¹¶æ³¨å†Œç™»å½• https://www.volcengine.com/
![](attachments\Pasted image 20250224114358.png)
é¡¶éƒ¨èœå•-å¤§æ¨¡å‹-ç«å±±æ–¹èˆŸ è·³è½¬é¡µé¢
è¿›å…¥ç«å±±æ–¹èˆŸæ§åˆ¶å° https://console.volcengine.com/ark

#### 3.2 å¼€é€šæœåŠ¡

ã€å¼€é€šç®¡ç†ã€‘
éœ€è¦ç”¨åˆ°çš„å¤§æ¨¡å‹ï¼š
- DeepSeek-R1ï¼šæ ¸å¿ƒæ¨ç†æ¨¡å‹
- Doubao-1.5-lite-32kï¼šç”¨äºå·¥ä½œæµæ„å›¾åˆ¤æ–­ã€Dify ä»£ç ç”Ÿæˆç­‰
![](attachments\Pasted image 20250224114907.png)

ã€API Key ç®¡ç†ã€‘
åˆ›å»ºä¸€ä¸ª API Key
![](attachments\Pasted image 20250224115211.png)

ã€åœ¨çº¿æ¨ç†-è‡ªå®šä¹‰æ¨ç†æ¥å…¥ç‚¹ã€‘
æ¯ä¸ªæ¨¡å‹åˆ›å»ºä¸€ä¸ªæ¨ç†æ¥å…¥ç‚¹
![](attachments\Pasted image 20250224115400.png)
æ¥å…¥ç‚¹åç§°è‡ªå®šä¹‰
å»ºè®®æŠŠæ¨¡å‹åç§°å†™è¿›æ¥å…¥ç‚¹åç§°ä¸­ï¼Œä¾¿äºåŒºåˆ†
![](attachments\Pasted image 20250224115544.png)
åœ¨ ã€è‡ªå®šä¹‰æ¥å…¥ç‚¹-APIè°ƒç”¨ã€‘ éƒ¨åˆ†å¯ä»¥çœ‹åˆ° OpenAI æ ¼å¼çš„è°ƒç”¨æ–¹å¼
- æ¥å…¥ç‚¹ base_urlï¼šhttps://ark.cn-beijing.volces.com/api/v3
- API Keyï¼šec67d64a-xxxx-xxxx-xxxx-xxx
- Model IDï¼šep-20250217120317-xxx
è¿™é‡Œçš„ Model ID ç›¸å½“äº gpt-4o/DeepSeek-R1 ç­‰æ¨¡å‹å‹å·ï¼Œç”¨çš„æ˜¯æ¨ç†æ¥å…¥ç‚¹ ID

## å››ã€æ³¨å†Œå¾®ä¿¡å°å·

å‚è€ƒ https://zhuanlan.zhihu.com/p/650276620
ã€è®¾ç½®-åˆ‡æ¢è´¦å·-æ·»åŠ è´¦å·-æ³¨å†Œæ–°è´¦å·ã€‘
é€šè¿‡å½“å‰å¾®ä¿¡çš„æ‰‹æœºå·è¾…åŠ©æ³¨å†Œ

å¦‚æœæ‰‹æœºç³»ç»Ÿæ”¯æŒå¤šå¼€å¾®ä¿¡æœ€å¥½ç”¨ç¬¬äºŒä¸ªå¾®ä¿¡ç™»å½•å°å·
![](attachments\Pasted image 20250224141151.png)
## äº”ã€éƒ¨ç½² AstrBot+Gewechat

é¡¹ç›®åœ°å€
AstrBot https://github.com/Soulter/AstrBot
Gewechat https://github.com/Devo919/Gewechat

#### 5.1 Docker å¯åŠ¨

ç»Ÿä¸€é‡‡ç”¨ docker run çš„æ–¹å¼å¯åŠ¨

ä½¿ç”¨ Docker éƒ¨ç½² AstrBot https://astrbot.app/deploy/astrbot/docker.html
```bash
PS C:\Docker\astrbot> docker run -itd -p 6180-6200:6180-6200 -p 11451:11451 -v $PWD/data:/AstrBot/data --name astrbot soulter/astrbot:latest
```
å¯åŠ¨ä¹‹åæœ€å¥½æ£€æŸ¥ä¸€ä¸‹å®¹å™¨çš„æ—¶åŒºï¼Œä»¥å…å‡ºç°æ—¶é—´æˆ³ä¸ä¸€è‡´çš„é—®é¢˜
```bash
PS C:\WINDOWS\system32> docker exec -it astrbot /bin/bash
root@9d65634803a7:/AstrBot## date
Tue Feb 25 11:07:03 CST 2025
```
å¦‚æœæ—¶åŒºä¸å¯¹å°±è¿›è¡Œä¿®æ”¹
```bash
root@9d65634803a7:/AstrBot## ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
root@9d65634803a7:/AstrBot## echo "Asia/Shanghai" > /etc/timezone
```

å¯åŠ¨ Gewechat Docker æœåŠ¡ https://github.com/Devo919/Gewechat?tab=readme-ov-file#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1
```bash
PS C:\Docker\astrbot> docker pull registry.cn-hangzhou.aliyuncs.com/gewe/gewe:latest
PS C:\Docker\astrbot> docker tag registry.cn-hangzhou.aliyuncs.com/gewe/gewe gewe
PS C:\Docker\astrbot> mkdir gewechat
PS C:\Docker\astrbot> docker run -itd -v gewechat:/root/temp -p 2531:2531 -p 2532:2532 --privileged=true --name=gewe gewe /usr/sbin/init
```
#### 5.2 é…ç½® AstrBot+Gewechat

ç™»å½•åˆ° http://localhost:6185 ï¼Œé»˜è®¤è´¦æˆ·å¯†ç  astrbot/astrbot

æ·»åŠ æ¶ˆæ¯å¹³å°

![](attachments\Pasted image 20250225101326.png)

æ·»åŠ å®Œä¹‹åé‡å¯ AstrBotï¼Œæ‰«ç ç™»å½•å¾®ä¿¡

![](attachments\Pasted image 20250225102731.png)

å¦‚æœé‡åˆ°â€œåˆ›å»ºè®¾å¤‡å¤±è´¥ï¼Œè·å–äºŒç»´ç å¤±è´¥â€çš„æŠ¥é”™ï¼Œå…³æ‰ä»£ç†ä¹‹åå†é‡å¯ AstrBot
https://github.com/Soulter/AstrBot/issues/398

è¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰é…ç½®å¤§æ¨¡å‹ï¼Œä½†æ˜¯å·²ç»è¿æ¥äº†å¾®ä¿¡
å¯ä»¥å‘é€å‘½ä»¤è¿›è¡Œæµ‹è¯•

ç¬¬ä¸€æ¬¡å‘é€çš„æ—¶å€™ä¼šæ§åˆ¶å°ä¼šæç¤º
```bash
 [03:33:21| INFO] [event_bus.py:21]: [gewechat] å¾®ä¿¡å/wxid_xxx: /help
[2025-02-11 03:33:21 +0000] [1] [INFO] 172.17.0.1:47086 POST /astrbot-gewechat/callback 1.1 200 20 1345
 [03:33:21| INFO] [stage.py:41]: ä¼šè¯ ID gewechat:FriendMessage:wxid_xxx ä¸åœ¨ä¼šè¯ç™½åå•ä¸­ï¼Œå·²ç»ˆæ­¢äº‹ä»¶ä¼ æ’­ã€‚è¯·åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è¯¥ä¼šè¯ ID åˆ°ç™½åå•ã€‚
```
åœ¨ã€é…ç½®ã€‘ä¸­å¼€å¯ç™½åå•ï¼Œç„¶åä¿å­˜é‡å¯ AstrBot

![](attachments\Pasted image 20250225103306.png)

å†æ¬¡æµ‹è¯•å‘½ä»¤

![](attachments\Pasted image 20250225103006.png)
#### 5.3 é…ç½® AstrBot+LLM

æ·»åŠ å¤§æ¨¡å‹æœåŠ¡å•†
ç¬¬ä¸€æ¬¡å»ºè®®æ·»åŠ ä¸€ä¸ªå…·å¤‡ Agent åŠŸèƒ½çš„æ¨¡å‹è¿›è¡Œæµ‹è¯•ï¼Œä¾‹å¦‚ gpt-4o-mini/doubao-1.5-lite-32k ä¹‹ç±»çš„

å‰é¢æˆ‘ä»¬å·²ç»å¼€é€šäº† DeepSeek-R1 å’Œ doubao-1.5-lite-32k
- æ¥å…¥ç‚¹ base_urlï¼šhttps://ark.cn-beijing.volces.com/api/v3
- API Keyï¼šec67d64a-xxxx-xxxx-xxxx-xxx
- Model IDï¼šep-20250217120317-xxx

è¿™é‡Œæ³¨æ„ã€æ–‡æœ¬ç”Ÿæˆæ¨¡å‹ã€‘å¡«å†™çš„æ˜¯æ¥å…¥ç‚¹ ID è€Œä¸æ˜¯ doubao-1.5-lite-32k

![](attachments\Pasted image 20250225103528.png)

å¯ä»¥åœ¨ã€é…ç½®ã€‘ä¸­è®¾ç½®
ä¾‹å¦‚äººæ ¼æƒ…æ™¯ã€è”ç½‘æ’ä»¶ã€ç¾¤èŠä¸Šä¸‹æ–‡è®°å½•ç­‰

![](attachments\Pasted image 20250225104058.png)

ç„¶åä¿å­˜å¹¶é‡å¯ AstrBotï¼Œåœ¨å¾®ä¿¡è¿›è¡Œæµ‹è¯•
ç”¨ /persona åˆ‡æ¢äººæ ¼ï¼Œ/provider åˆ‡æ¢æ¨¡å‹ï¼Œ/new å’Œ /switch å’Œ /ls ç®¡ç†å¯¹è¯ç­‰

åœ¨ç§èŠä¸­ç›´æ¥å¯¹è¯å³å¯
åœ¨ç¾¤èŠä¸­æŠŠå¢¨ç¼‡ä¸æ‹‰è¿›ç¾¤ç„¶å @å¢¨ç¼‡ä¸ è¿›è¡Œå¯¹è¯ï¼Œä¹Ÿå¯ä»¥åœ¨é…ç½®ä¸­åŠ ä¸Šè‡ªå®šä¹‰çš„å”¤é†’å‰ç¼€è¯
åœ¨å¾®ä¿¡ä¸­æ‰‹åŠ¨ @ å’Œå¤åˆ¶æ¶ˆæ¯çš„ @ æ˜¯ä¸åŒçš„

![](attachments\Pasted image 20250225103734.png)

### å…­ã€éƒ¨ç½² Dify+new-api

è‡³æ­¤æˆ‘ä»¬èƒ½å¤Ÿè·‘é€š AstrBot ä¸ºæ ¸å¿ƒçš„ï¼Œæ¥å…¥å¤§æ¨¡å‹ä¾›åº”å•†çš„å¾®ä¿¡æœºå™¨äºº
é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è¦æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå°±éœ€è¦ä½¿ç”¨ Dify æ¡†æ¶
è¿™é‡Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨ Dify å¯¹è¯æµè¿›è¡Œç¼–æ’

é¡¹ç›®åœ°å€
Dify https://github.com/Soulter/AstrBot
new-api https://github.com/Calcium-Ion/new-api
#### 6.1 Docker å¯åŠ¨

Dify éƒ¨ç½²éœ€è¦ä½¿ç”¨ Docker Compose https://docs.dify.ai/zh-hans/getting-started/install-self-hosted/docker-compose
```bash
git clone https://github.com/langgenius/dify.git
cd dify/docker
cp .env.example .env
docker compose up -d
```
ä¼šå¯åŠ¨ä¸€å…± 9 ä¸ªå®¹å™¨ï¼Œæ³¨æ„æ£€æŸ¥å…¨éƒ¨è¿›å…¥ running çŠ¶æ€å³å¯åŠ¨æˆåŠŸ
å¦‚æœæœ‰é—®é¢˜å°±æ£€æŸ¥ docker logs
ä¸€èˆ¬æ˜¯ redis å®¹å™¨å’Œ db å®¹å™¨å¯åŠ¨å¤±è´¥ä¸€ç›´ restartingï¼Œé€šè¿‡ docker-compose.yml ä¸­ä¿®æ”¹å®¹å™¨ priviledged ç­‰æ–¹å¼è§£å†³

![](attachments\Pasted image 20250225110243.png)

new-api é€šè¿‡ Docker éƒ¨ç½² https://github.com/Calcium-Ion/new-api?tab=readme-ov-file#%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8-docker-%E9%95%9C%E5%83%8F
```bash
docker run --name new-api -d --restart always -p 3000:3000 -e TZ=Asia/Shanghai -v /home/ubuntu/data/new-api:/data calciumion/new-api:latest
```
#### 6.2 é…ç½® Dify

å¯åŠ¨ä¹‹åé¦–æ¬¡ç™»å½• Dify http://localhost/install è®¾ç½®ç®¡ç†å‘˜

![](attachments\Pasted image 20250225111050.png)
è®¾ç½®å®Œä¹‹åç™»å½•ä¸»é¡µã€å³ä¸Šè§’-è®¾ç½®-æ¨¡å‹ä¾›åº”å•†ã€‘ï¼Œæ·»åŠ ç«å±±æ¨¡å‹
æ¨¡å‹åç§°è‡ªå®šä¹‰ï¼Œã€é‰´æƒæ–¹å¼ã€‘é€‰æ‹© API Key

![](attachments\Pasted image 20250225111250.png)

#### 6.3 åˆ›å»ºåˆå§‹å¯¹è¯æµ

åœ¨ã€å·¥ä½œå®¤-åˆ›å»ºç©ºç™½åº”ç”¨ã€‘ï¼Œæ¨èé€‰æ‹© Chatflow
ç›®å‰ new-api æ”¯æŒèŠå¤©åŠ©æ‰‹ã€æ–‡æœ¬ç”Ÿæˆã€Chatflowã€å·¥ä½œæµï¼Œå¥½åƒä¸æ”¯æŒ Agent

![](attachments\Pasted image 20250225111441.png)

åˆ›å»ºå®Œäº†ä¹‹åæ˜¯ä¸€ä¸ªç®€å•çš„å¯¹è¯ï¼Œå³ä¸Šè§’å‘å¸ƒå³å¯

![](attachments\Pasted image 20250225111645.png)

å¯ä»¥å…ˆåœ¨ã€é¢„è§ˆã€‘ä¸­è¿›è¡Œæœ¬åœ°æµ‹è¯•ï¼Œç¡®è®¤æ¨¡å‹è·‘é€š

![](attachments\Pasted image 20250225111745.png)

è·‘é€šä¹‹ååœ¨ã€è®¿é—®APIã€‘éƒ¨åˆ†ï¼Œåˆ›å»º API Keyï¼šapp-xxx
åœ¨å¤–éƒ¨è°ƒç”¨ Dify ä¸åŒçš„å·¥ä½œæµï¼Œæ˜¯é€šè¿‡ API Key è¿›è¡ŒåŒºåˆ†çš„

![](attachments\Pasted image 20250225111831.png)
#### 6.4 é…ç½® new-api+AstrBot

å®Œæˆ Dify åˆå§‹å¯¹è¯æµçš„åˆ›å»ºä¹‹å
ç™»å½• new-api http://localhost:3000 ï¼Œé»˜è®¤è´¦å·å¯†ç  root/123456

åœ¨ã€æ¸ é“-æ·»åŠ æ¸ é“ã€‘æ·»åŠ  Dify å·¥ä½œæµ
- åç§°éšæ„
- BaseURL ä¸æ˜¯ http://localhost è€Œæ˜¯ http://host.docker.internal
- å¯†é’¥æ˜¯å‰é¢åœ¨ Dify å¯¹è¯æµä¸­åˆ›å»ºçš„ API Key
- æ¨¡å‹å»ºè®®æ¸…ç©ºæ‰€æœ‰æ¨¡å‹åˆ—è¡¨ï¼Œç„¶åå¡«å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„åç§°

![](attachments\Pasted image 20250225112618.png)

åœ¨ã€ä»¤ç‰Œ-æ·»åŠ ä»¤ç‰Œã€‘æ–°å»ºä¸€ä¸ªè®¿é—®æƒé™
- å¯ä»¥è®¾ç½®æ°¸ä¸è¿‡æœŸ+æ— é™é¢åº¦
å¤åˆ¶å¾—åˆ° new-api çš„ API Keyï¼šsk-xxx

æ³¨æ„ï¼Œä¸€ä¸ª Dify å·¥ä½œæµå¯¹åº”ä¸€ä¸ªæ¸ é“ï¼Œè€Œä»¤ç‰Œåªåˆ›å»ºä¸€ä¸ªå³å¯

![](attachments\Pasted image 20250225112907.png)

å›åˆ° AstrBotï¼Œæ·»åŠ  new-api çš„è®¿é—®æ–¹å¼
- API Key å¤åˆ¶åˆšæ‰ new-api çš„ä»¤ç‰Œ
- åœ°å€å¯¹åº” new-api çš„ç«¯å£
- æ¨¡å‹åç§°å¯¹åº” new-api æ¸ é“é‡Œå¡«å…¥çš„æ¨¡å‹åç§°
å®Œæˆé…ç½®åç”¨ /provider åœ¨èŠå¤©é‡Œåˆ‡æ¢æ¨¡å‹

![](attachments\Pasted image 20250225113154.png)

## ä¸ƒã€è®¾è®¡ Dify å¯¹è¯æµ

æˆ‘ä»¬å·²ç»èµ°é€šäº† Dify+new-api+AstrBot+Gewechat çš„æ•´ä¸ªæ¡†æ¶
æ¥ä¸‹æ¥å°±è¿›å…¥æ­£é¢˜å¼€å§‹æ„å»ºå¯¹è¯æµäº†

å¦‚æœä¸æƒ³çœ‹æ„å»ºå¯¹è¯æµçš„è¿‡ç¨‹å¯ä»¥ç›´æ¥æŠ„ä½œä¸š
ä¿å­˜ dsl æ–‡ä»¶ç›´æ¥å¯¼å…¥åˆ° Dify å³å¯
DSL æ–‡ä»¶å¤ªé•¿äº†ï¼Œæˆ‘åé¢åœ¨è¯„è®ºåŒºè´´å‡ºæ¥
![](attachments\Pasted image 20250225114418.png)
#### 7.1 è¾“å…¥å¤„ç†

AstrBot æ”¯æŒç¾¤èŠä¸Šä¸‹æ–‡ï¼Œéœ€è¦ OpenAI æ ¼å¼çš„æ¥å£æ‰ä¼šå¯ç”¨ï¼Œé»˜è®¤çš„ Dify å·¥ä½œæµä¸å¯ç”¨
è¿™æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ new-api ä¸­è½¬

è®©æˆ‘ä»¬åœ¨ Dify åå°çœ‹çœ‹ç¾¤èŠçš„æ ¼å¼
```json
{
Â  "sys.query": "SYSTEM: \n\nCurrent datetime: 2025-02-21 14:38\nYou are now in a chatroom. The chat history is as follows: \n[æ„¿é€æœˆå/06:37:50]: Â /new\n---\n[æ„¿é€æœˆå/06:37:51]: Â /reset\n---\n[æ„¿é€æœˆå/06:38:01]: Â ä½ å¥½å•Šå¢¨ç¼‡ä¸\nUSER: \n\n[User ID: wxid_xxx, Nickname: æ„¿é€æœˆå]\nä½ å¥½å•Šå¢¨ç¼‡ä¸\n",
Â  "sys.files": [],
Â  "sys.conversation_id": "6a8684c5-f373-46fb-8aad-d664ab99152d",
Â  "sys.user_id": "api-user",
Â  "sys.dialogue_count": 0,
Â  "sys.app_id": "b29d7337-c169-4a0b-8d72-8b52c1906609",
Â  "sys.workflow_id": "e91d8eae-937a-4067-93b0-bb72091c230b",
Â  "sys.workflow_run_id": "6852c677-19b6-4367-9b1a-5501d1ec1a63"
}
```
![](attachments\Pasted image 20250225162558.png)
![](attachments\Pasted image 20250225162834.png)

æ•´ç†ä¸‹æ¥å¤§æ¦‚æ˜¯è¿™æ ·çš„å†…å®¹
```python
'''
SYSTEM:
You are now in a chatroom. The chat history is as follows:
[Ê• â€¢á´¥â€¢Ê”/15:24:50]: ä½ å¥½

USER:
[User ID: wxid_xxx, Nickname: æ„¿é€æœˆå]
ä½ å¥½å•Šå¢¨ç¼‡ä¸

ASSISTANT:
ğŸ’­ å¥½çš„ï¼Œæˆ‘ç°åœ¨éœ€è¦å¤„ç†ç”¨æˆ·å‘æ¥çš„æ¶ˆæ¯â€œä½ å¥½å•Šå¢¨ç¼‡ä¸â€ã€‚é¦–å…ˆï¼Œç”¨æˆ·ä½¿ç”¨äº†ä¸­æ–‡æ‰“æ‹›å‘¼ï¼Œè¿™å¯èƒ½æ„å‘³ç€ä»–ä»¬å¸Œæœ›ç”¨ä¸­æ–‡è¿›è¡Œäº¤æµã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘è¦ç¡®è®¤ç”¨æˆ·æ˜¯å¦åœ¨ä¹‹å‰çš„å¯¹è¯ä¸­æœ‰ç‰¹å®šçš„éœ€æ±‚æˆ–ä¸Šä¸‹æ–‡éœ€è¦å¤„ç†ã€‚

æŸ¥çœ‹å†å²è®°å½•ï¼Œç”¨æˆ·ä¹‹å‰å‘é€äº†/newå’Œ/resetå‘½ä»¤ï¼Œè¿™å¯èƒ½è¡¨ç¤ºä»–ä»¬æƒ³è¦å¼€å§‹æ–°çš„å¯¹è¯æˆ–é‡ç½®ä¹‹å‰çš„ä¼šè¯ã€‚å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯æ˜¯â€œä½ å¥½å•Šå¢¨ç¼‡ä¸â€ï¼Œçœ‹èµ·æ¥åƒæ˜¯ä¸€èˆ¬çš„é—®å€™ï¼Œä½†ç»“åˆä¹‹å‰çš„å‘½ä»¤ï¼Œç”¨æˆ·å¯èƒ½å¸Œæœ›é‡æ–°å¼€å§‹å¯¹è¯ï¼Œæ‰€ä»¥éœ€è¦ç¡®è®¤æ˜¯å¦éœ€è¦é‡ç½®ä¹‹å‰çš„ä¸Šä¸‹æ–‡ã€‚

å¦å¤–ï¼Œç”¨æˆ·IDæ˜¯wxid_xxxï¼Œæ˜µç§°æ˜¯â€œæ„¿é€æœˆåâ€ã€‚åœ¨å›åº”æ—¶ï¼Œä½¿ç”¨æ˜µç§°å¯ä»¥å¢åŠ äº²åˆ‡æ„Ÿã€‚éœ€è¦ç¡®ä¿å›åº”å‹å¥½ä¸”ç¬¦åˆç”¨æˆ·çš„è¯­è¨€é£æ ¼ï¼Œå³ä½¿ç”¨ä¸­æ–‡è¿›è¡Œå›å¤ã€‚

è€ƒè™‘åˆ°ç”¨æˆ·å¯èƒ½å·²ç»é‡ç½®äº†å¯¹è¯ï¼Œå›åº”åº”è¯¥ç®€æ´ï¼ŒåŒæ—¶ä¿æŒå¼€æ”¾ï¼Œé‚€è¯·ç”¨æˆ·è¿›ä¸€æ­¥è¯´æ˜éœ€æ±‚ã€‚ä¾‹å¦‚ï¼Œè¯¢é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä»–ä»¬çš„åœ°æ–¹ã€‚åŒæ—¶ï¼Œæ³¨æ„ä¸è¦æåŠä¹‹å‰çš„å¯¹è¯å†å²ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½å·²ç»é€šè¿‡/resetæ¸…é™¤äº†ä¹‹å‰çš„ä¸Šä¸‹æ–‡ã€‚

æœ€åï¼Œè¦æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç³»ç»Ÿæˆ–æ—¶é—´ç›¸å…³çš„ä¿¡æ¯éœ€è¦å¤„ç†ï¼Œå½“å‰æ—¶é—´æ˜¯2025å¹´2æœˆ21æ—¥14:38ï¼Œä½†ç”¨æˆ·çš„æ¶ˆæ¯ä¸­æ²¡æœ‰æ¶‰åŠæ—¶é—´æ•æ„Ÿçš„å†…å®¹ï¼Œå› æ­¤å¯ä»¥å¿½ç•¥æ—¶é—´å› ç´ ã€‚æ€»ç»“å›åº”éœ€è¦å‹å¥½ã€ç®€æ´ï¼Œå¹¶é¼“åŠ±ç”¨æˆ·æå‡ºå…·ä½“è¯·æ±‚ã€‚

USER:
[User ID: wxid_xxx, Nickname: Ê• â€¢á´¥â€¢Ê”]
ä½ å¥½
'''
```
å…¶ä¸­ï¼ŒSYSTEM é‡Œé¢åŒ…æ‹¬äº†èƒŒæ™¯ä¿¡æ¯å’Œä¸€éƒ¨åˆ†çš„å¯¹è¯å†å²
åé¢çš„å¯¹è¯å†å²ä»¥ USER: ASSISTANT: USER: è¿™æ ·çš„æ ¼å¼è¿›è¡Œ

é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆéœ€è¦å°†æœ€æ–°ä¸€æ¡ USER ä½œä¸º prompt_user
å‰é¢çš„æ‰€æœ‰å†å²è®°å½•ä½œä¸º prompt_system

è¿™æ ·åšæ˜¯ä¸ºäº†åŒºåˆ†æœ€æ–°ä¸€æ¡ä¿¡æ¯çš„æ„å›¾ï¼Œåœ¨æ¡ä»¶åˆ†æ”¯ä¸­åˆ¤æ–­æœç´¢
ä¹Ÿå¯ä»¥ç”¨ doubao-lite è¿›è¡Œé—®é¢˜åˆ†ç±»å™¨æ„å›¾åˆ¤æ–­

åŒæ—¶æŒ‚ä¸€ä¸ªè·å–å½“å‰æ—¶é—´çš„å·¥å…·ï¼Œä¾¿äºæœç´¢æŸ¥è¯¢
![](attachments\Pasted image 20250225163805.png)
ä»£ç æ‰§è¡Œéƒ¨åˆ†å¦‚ä¸‹
```python
import re

def main(query: str) -> dict:
    ## æŒ‰æœ€åä¸€æ¬¡å‡ºç° "USER: \n\n" åˆ‡åˆ†
    parts = query.rsplit('USER: \n\n', 1)
    if len(parts) == 2:
        query_system = parts[0].strip()
        query_user = parts[1].strip()
        ## å¦‚æœéœ€è¦æ›¿æ¢ç³»ç»Ÿæç¤ºä¸­çš„æŸäº›æ–‡å­—ï¼Œå¯è‡ªè¡Œè°ƒæ•´ï¼Œæ¯”å¦‚ï¼š
        query_system = query_system.replace('You are now in a chatroom. The chat history is as follows', 'ç¾¤èŠçš„å†å²çºªå½•å¦‚ä¸‹')
        return {
            'query_system': query_system,
            'query_user': query_user
        }
    return {
        'query_system': '',
        'query_user': query
    }
```
#### 7.2 ç›´æ¥å›å¤

å¦‚æœä¸éœ€è¦æœç´¢ï¼Œé‚£ä¹ˆå°±èµ°ç›´æ¥å›å¤çš„è·¯çº¿
æˆ‘ä»¬è®¾å®š system prompt å³å¯

æˆ‘å°è¯•è¿‡åœ¨ prompt é‡Œå¡å¢¨ç¼‡ä¸çš„è®¾å®š
ä½†æ˜¯æ•ˆæœä¸å¥½ï¼Œå›ç­”çš„æ—¶å€™æœ‰è‚¡æ€ªå‘³ï¼Œä¸é€‚åˆå½“ç¾¤èŠæœºå™¨äºº
DeepSeekæ˜¯çŸ¥é“Ave Mujicaçš„ï¼Œä½†æ˜¯ä¸çŸ¥é“å¢¨ç¼‡ä¸
ä¸€æ—¦å¼€å§‹è¿‡åº¦ Cosplay ä¹‹åçš„å›ç­”æ–¹å‘éƒ½ä¼šè·‘å

å› æ­¤æœ€ååªå‘Šè¯‰äº†å¥¹åå­—
```text
ä½ æ˜¯ç¾¤èŠçš„ä¸€ä¸ªæˆå‘˜ï¼Œå¤§å®¶å¯èƒ½ä¼šå«ä½ å¢¨ç¼‡æ–¯ã€å¤§è«è€å¸ˆã€å°è«ã€Mortisç­‰ã€‚ä¸éœ€è¦è¿‡å¤šå¤¸å¼ çš„è§’è‰²æ‰®æ¼”ï¼Œç¾¤å‹ä¹ŸçŸ¥é“ä½ æ˜¯DeepSeekï¼Œä¿æŒæ­£å¸¸é£æ ¼äº¤æµå³å¯ï¼Œè¯·ä»¥ç¾¤å‹çš„èº«ä»½å’Œå¤§å®¶èŠå¤©ã€‚
åŸºäºå¾®ä¿¡ç¾¤èŠçš„èŠå¤©ï¼Œå› æ­¤å›ç­”ä¸­ä¸è¦å¸¦æœ‰markdownä¸­çš„æ ¼å¼æ¸²æŸ“ç¬¦å·ï¼Œä¾‹å¦‚ç”¨**è¡¨ç¤ºåŠ ç²—ç­‰ã€‚
å½“å‰æ—¶é—´ï¼š{{å½“å‰æ—¶é—´}}
{{query_system}}
```
![](attachments\Pasted image 20250225164356.png)
#### 7.3 å¼€é€šç«å±±å¼•æ“è”ç½‘æœç´¢

åœ¨å°è¯•ç«å±±å¼•æ“ä¹‹å‰ï¼Œæˆ‘å°è¯•è¿‡ Jina å’Œ Bing

Jina è¦ \$20/1B tokensï¼Œç›¸å½“äº \$0.02/1M tokens
æœç´¢è´¨é‡å¾ˆé«˜ï¼Œè€Œä¸”ç»è¿‡åŠ å·¥æˆMarkdownä¹‹åå†ç»™æ¨¡å‹
ä½†æ˜¯ä¸æ˜¯å¾ˆèˆå¾—ä¸€æ¬¡æ€§ç»™20åˆ€

Bing è¦ VISA å¡ï¼Œæ¯å¤©æœ‰å…è´¹é¢åº¦
æˆ‘ä¸“é—¨å»å¼€äº†ä¸ªå¡ï¼Œç»“æœ API å¼€é€šä¸äº†
æ®ç½‘ä¸Šè¯´æ˜¯ Bing å®˜æ–¹å¼€é€šæ¥å£æœ‰é—®é¢˜

å…¶ä»–æœç´¢å¼•æ“ä¸ç”¨è€ƒè™‘äº†ï¼Œä¾‹å¦‚ DuckDuckGoã€SearXNG ç­‰ç­‰ï¼Œæœç´¢å›½å†…å†…å®¹è´¨é‡ä¸å¯ç”¨

æš‚æ—¶ä½¿ç”¨æ›²çº¿æ•‘å›½çš„æ–¹å¼
ã€ç«å±±æ–¹èˆŸ-æˆ‘çš„åº”ç”¨-åˆ›å»ºåº”ç”¨-é›¶ä»£ç æ¨¡å¼ã€‘

![](attachments\Pasted image 20250225165323.png)

åˆ›å»ºä¸€ä¸ªç©ºç™½çš„å¸¦è”ç½‘æ’ä»¶çš„åº”ç”¨å³å¯ï¼Œç„¶åå‘å¸ƒ
ä¸éœ€è¦æç¤ºè¯ï¼Œç”± Dify æä¾›æç¤ºè¯

![](attachments\Pasted image 20250225165346.png)
#### 7.4 Dify æ¥å…¥ç«å±±è”ç½‘åº”ç”¨

å› ä¸ºç«å±±åº”ç”¨éœ€è¦ç”¨åº”ç”¨ ID `bot-xxx` ä»£æ›¿æ¨¡å‹ ID `ep-xxx`
è€Œä¸”éœ€è¦è®¾ç½®éæµå¼æ¨ç†ç­‰å‚æ•°
å› æ­¤æˆ‘é€‰æ‹©ä½¿ç”¨ HTTP æ–¹å¼è°ƒç”¨ï¼Œè€Œä¸æ˜¯ Dify å†…ç½® LLM æ–¹å¼

å…·ä½“ä½¿ç”¨æ–¹å¼åœ¨ã€ç«å±±æ–¹èˆŸ-åº”ç”¨-ç¼–è¾‘-APIè°ƒç”¨æŒ‡å—ã€‘ä¸­

ä½¿ç”¨ POST æ–¹å¼
Authorizationï¼šBeaver xxxxï¼ˆå¡«å…¥API Keyï¼‰
Bodyï¼šé€‰æ‹© JSON æ–¹å¼ï¼Œæ³¨æ„éæµå¼æ¨ç†å¹¶è®¾ç½®æœ€å¤§è¾“å‡ºé•¿åº¦
```json
{
  "model": "bot-20250223031134-xxx",
  "stream": false,
  "max_tokens": 1024,
  "messages": [
    {
      "role": "system",
      "content": "ä½ æ˜¯ç¾¤èŠçš„ä¸€ä¸ªæˆå‘˜ï¼Œå¤§å®¶å¯èƒ½ä¼šå«ä½ å¢¨ç¼‡ä¸ã€å¤§è«è€å¸ˆã€å°è«ã€Mortisç­‰ã€‚ä¸éœ€è¦è¿‡å¤šå¤¸å¼ çš„è§’è‰²æ‰®æ¼”ï¼Œç¾¤å‹ä¹ŸçŸ¥é“ä½ æ˜¯DeepSeekï¼Œä¿æŒæ­£å¸¸é£æ ¼äº¤æµå³å¯ï¼Œè¯·ä»¥ç¾¤å‹çš„èº«ä»½å’Œå¤§å®¶èŠå¤©ã€‚\\nåŸºäºå¾®ä¿¡ç¾¤èŠçš„èŠå¤©ï¼Œå› æ­¤å›ç­”ä¸­ä¸è¦å¸¦æœ‰markdownä¸­çš„æ ¼å¼æ¸²æŸ“ç¬¦å·ï¼Œä¾‹å¦‚ç”¨**è¡¨ç¤ºåŠ ç²—ç­‰ã€‚é€‚å½“åœ°ç”¨æ¢è¡Œæˆ–è€…ä¸¤ä¸ªæ¢è¡Œè¿›è¡Œåˆ†æ®µï¼Œæ›´åŠ ç¾è§‚æ•´é½\\nå½“å‰æ—¶é—´ï¼š{{text}}\\n{{query_system}}"
    },
    {
      "role": "user",
      "content": "{{#1740122268305.query_user#}}"
    }
  ]
}
```
![](attachments\Pasted image 20250225165834.png)

è€ƒè™‘åˆ°è”ç½‘æœç´¢çš„æ€ç»´é“¾ä¼šå¾ˆé•¿ï¼Œå¾®ä¿¡æœ‰æœ€å¤§æ¶ˆæ¯é•¿åº¦é™åˆ¶
å› æ­¤è”ç½‘æœç´¢éƒ¨åˆ†ä¸è¾“å‡ºæ€ç»´é“¾ï¼Œåªè¾“å‡ºç»“æœ
ç›´æ¥å›å¤æ—¶é€‰æ‹© answer
```python
import json


def main(response: str) -> dict:
    body_dict = json.loads(response)
    choices = body_dict["choices"]
    message = choices[0]["message"]
    content = message["content"]
    reasoning_content = message["reasoning_content"]
    return {
        "reasoning": reasoning_content,
        "answer": content
    }
```
åˆ°è¿™é‡Œå°±å®Œæˆæ•´ä¸ªå·¥ä½œæµäº†
## é™„å½•

çœ‹çœ‹ AstrBot å¯¹è¯ä¸Šä¸‹æ–‡è½®æ¬¡è®¾ç½®ä¸º 100 æ—¶çš„ Token æ¶ˆè€—
å¤šçš„æ—¶å€™ä¸€å¤©æ¶ˆè€—å¤§æ¦‚ 200kï¼Œä¸åˆ° 0.8 å…ƒ

![](attachments\Pasted image 20250225170440.png)

è”ç½‘æœç´¢å¼•ç”¨æ•°é‡10+ä¸Šä¸‹æ–‡è½®æ¬¡100 çš„æ—¶å€™ï¼Œ14 æ¬¡è°ƒç”¨æ¶ˆè€—äº† 74k
![](attachments\Pasted image 20250225170730.png)
å»ºè®®æ˜¯é‚€è¯·ç¾¤å‹æ³¨å†Œç«å±±æ–¹èˆŸï¼Œä¸€ä¸ªäººé€30å—ï¼Œå¥½å‹èƒ½é€15å—
ç„¶åå¾®ä¿¡ç¾¤èŠä¸Šä¸‹æ–‡è®¾ç½®ä½ä¸€ç‚¹
ä»¥åå¯èƒ½ä¼šè€ƒè™‘åŠ å…¥é•¿æ—¶è®°å¿†åŠŸèƒ½ï¼Œè®©å¤§æ¨¡å‹å®šæœŸæ€»ç»“èŠå¤©è®°å½•
æˆ–è€…æ˜¯æ¥å…¥ Bing ä¹‹åè‡ªå·±å¤„ç†è”ç½‘æœç´¢çš„è¿‡ç¨‹